# Домашнее задание № 4

Домашнее задание посвещено продвинутым фишкам PostgreSQL

## Служебные функции БД

Используя функцию определения размера таблицы, вывести top-5 самых больших таблиц базы.

## Специфические функции Postgres

Используя специальные функции постгри, найдём пользователей с самыми похожими вкусами, на основе просмотренных фильмах.

1) Используя функцию array_agg собрать в массив все фильмы, просмотренные пользователем. 
При этом повторов в списке контента быть не должно.

2) Создайте таблицу user_movies_agg, в которую сохраните результат запроса

3) Используя следующий синтаксис, создайте функцию cross_arr оторая принимает на вход два массива arr1 и arr2. 
Функциия возвращает массив, который представляет собой пересечение контента из обоих списков.

Примечание - по именам к аргументам обращаться не получится, придётся делать через $1 и $2.

Подсказка: используйте SQL оператор [INTERSECT](https://github.com/Dju999/flask_docker_app/blob/master/slides/simple_dataset_merge.md).

CREATE OR REPLACE FUNCTION cross_arr (int[], int[]) RETURNS int[] language sql as $FUNCTION$ тело_функции ; $FUNCTION$;

тело_функции - это SQL запрос. В этом запросе нужно сделать INTERSECT между UNNEST(arr1) и UNNEST(arr2).

Из результата INTESECT нужно снова сделать массив.

4) Сформируйте запрос следующего вида: достать из таблицы всевозможные наборы u1, r1, u2, r2.
u1 и u2 - это id пользователей
r1 и r2 - соответствующие массивы рейтингов

Тривиальных пар (где u1==u2) быть не должно. Результат запроса оформите как CTE.

Примените к CTE функцию cross_arr. Результат запроса - u1, u2, crossed_array - id двух пользователей и их общие фильмы.

Создайте табличку common_user_views, куда сохраните результат запроса.

Отсортируйте выборку из common_user_views по длине crossed_array и оставите топ-10 пользователей с самыми большими пересечениями.

Создайте по аналогии с cross_arr функцию diff_arr, которая вычитает один массив из другого.

Подсказка: используйте оператор SQL [EXCEPT](https://github.com/Dju999/flask_docker_app/blob/master/slides/simple_dataset_merge.md).

CREATE OR REPLACE FUNCTION diff_arr (int[], int[]) RETURNS int[] language sql as $FUNCTION$ тело_функции ; $FUNCTION$;

Сформируйте рекомендации - для каждой пары посоветуйте для u1 контент, который видел u2, но не видел u1 (в виде массива).

Подсказка: нужно заджойнить user_movies_agg и common_user_views и применить вашй функцию к соответствующим полям.


Итоговая выборка:
<pre>
u1 recs1
u2 recs2
u3 recs3
...
</pre>
